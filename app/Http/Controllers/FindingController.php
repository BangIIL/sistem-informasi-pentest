<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Finding;
use App\Models\Project;
use App\Models\Test;
use App\Models\Mastervulnerability;

class FindingController extends Controller
{
    public function index(Project $project){
        $findings = $project->findings;
        return view('project.finding.index',compact ('project', 'findings'));
    }

    public function create(Project $project){
        $mastervulnerability = Mastervulnerability::all();
        return view('project.finding.create',[
            'project' => $project,
            'mastervulnerability' => $mastervulnerability,
        ]);
    }

    public function store(Request $request, Project $project){
        // dd($request->all());

        $request->validate([
            'mastervulnerability_id' => 'required|exists:mastervulnerabilities,id',
            'affected_component' => 'required',
            'risk' => 'required|numeric|between:0.0,10.0',
            'cvss' => 'required',
            'status' => 'required|in:Fix,Accented,N/A,Open',
            'reference' => 'required',
        ]);

        $finding = new Finding;
        $finding->mastervulnerability_id = $request->input('mastervulnerability_id');
        $finding->affected_component = $request->input('affected_component');
        $finding->risk = $request->input('risk');
        $finding->cvss = $request->input('cvss');
        $finding->status = $request->input('status');
        $finding->reference = $request->input('reference');

        $project->findings()->save($finding);

        session()->flash('success', "Finding berhasil ditambahkan!");
        return redirect()->route('finding.index', ['project' => $project->id]);
    }

    public function edit(Project $project, Finding $finding){
        $mastervulnerability = Mastervulnerability::all();

        return view('project.finding.edit',[
            'finding' => $finding,
            'project' => $project,
            'mastervulnerability' => $mastervulnerability,
        ]);

    }

    public function update(Request $request, Project $project, Finding $finding){
        $request->validate([
            'mastervulnerability_id' => 'required|exists:mastervulnerabilities,id',
            'affected_component' => 'required',
            'risk' => 'required|numeric|between:0.0,10.0',
            'cvss' => 'required',
            'status' => 'required|in:Fix,Accented,N/A,Open',
            'reference' => 'required',
        ]);

        $finding->mastervulnerability_id = $request->input('mastervulnerability_id');
        $finding->affected_component = $request->input('affected_component');
        $finding->risk = $request->input('risk');
        $finding->cvss = $request->input('cvss');
        $finding->status = $request->input('status');
        $finding->reference = $request->input('reference');

        $project->findings()->save($finding);

        session()->flash('success', "Finding berhasil diupdate!");
        return redirect()->route('finding.index', ['project' => $project->id]);
    }

    public function destroy($project_id, $finding_id){
        // Temukan finding berdasarkan ID dan ID proyek
        $finding = Finding::where('id', $finding_id)->where('project_id', $project_id)->first();

        if($finding){
            $project = Project::find($project_id);

            // Hapus finding jika ditemukan
            $finding->delete();

            return redirect()->route('finding.index',['project' => $project_id])->with('success','Finding berhasil dihapus dari proyek ' .$project->name);
        }
    }

    public function detail(Project $project, Finding $finding){
        $tests = Test::all();
        return view('project.finding.detail',compact ('project', 'finding','tests'));
    }
}
