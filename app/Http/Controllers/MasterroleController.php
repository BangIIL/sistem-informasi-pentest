<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Role;
use App\Models\Permission;
use Illuminate\Support\Facades\Validator;

class MasterroleController extends Controller
{
    public function index(){
        $roles = Role::where('name', '!=', 'super admin')->get();
        return view('master.role.index',[
            'roles' => $roles,
        ]);
    }

    public function store(Request $request){
        $rules = array(
            'name' => 'required|string|min:3|max:255|unique:roles,name',
            'description' => 'required',
        );

        $validator = Validator::make($request->all(), $rules);

        if($validator->fails()) {
            return redirect()->back()->withInput()->with('error', 'CreateModal')->withErrors($validator);
        }

        $role = new Role;
        $role->name = $request->input('name');
        $role->description = $request->input('description');
        $role->save();

        session()->flash('success', "Role $request->name berhasil ditambahkan");
        return redirect()->route('masterrole.index');
    }

    public function update(Request $request, Role $role){
        $rules = array(
            'name_edit' => 'required|string|min:3|max:255|unique:roles,name,' . $role->id,
            'description_edit' => 'required',
        );

        $validator = Validator::make($request->all(), $rules);

        if($validator->fails()) {
            return redirect()->back()->with('error', 'EditModal')->with('id_modal', $role->id)->withErrors($validator);
        }

        $role->name = $request->input('name_edit');
        $role->description = $request->input('description_edit');
        $role->save();

        return redirect()->route('masterrole.index')->with('success', "Role $role->name berhasil di update");
    }

    public function destroy(Role $role){
        $role->delete();

         // Simpan nama user yang dihapus dalam variabel
        $roleName = $role->name;

        session()->flash('success', "Role $roleName berhasil dihapus");
        return redirect()->route('masterrole.index');
    }

    public function buatPermission(Role $role){
        $permissions = Permission::all();

        $permissions_sudah_diambil = $role->permissions->pluck('id')->all();

        // dd($permissions_sudah_diambil);

        return view('master.role.buat-permission',
        [
            'role' => $role,
            'permissions' => $permissions,
            'permissions_sudah_diambil' => $permissions_sudah_diambil,
        ]);
    }

    public function prosesbuatPermission(Request $request, Role $role){

        // dd($request->all());

        $permissions = Permission::all()->pluck('id')->toArray();

        $validateData = $request->validate([
            'permission.*' => 'distinct|in:'.implode(',',$permissions),
        ]);

        $role->permissions()->sync($validateData['permission'] ?? []);

        session()->flash('success', "Permission $role->name berhasil diubah");
        return redirect()->route('masterrole.index');
    }
}
